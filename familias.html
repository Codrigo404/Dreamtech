<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Tech | Gest√£o de Fam√≠lias</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/familias.css">
</head>
<body class="dark-mode">

    <header class="header">
        <div class="logo"><span>Dream</span>Tech.</div>
        <nav class="navbar">
            <a href="index.html">Home</a>
            <a href="sobreNos.html">Sobre N√≥s</a>
            <a href="acoessociais.html" class="active">A√ß√µes Sociais</a>
            <a href="instituto.html">Instituto</a>
            <a href="contato.html">Contato</a>
        </nav>
        <div class="header-actions">
            <button id="theme-toggle" class="btn-theme">‚òÄÔ∏è</button>
        </div>
    </header>

    <main class="container">
        
        <section class="form-header">
            <h1>Gest√£o de Fam√≠lias</h1>
            <p>Cadastro, Listagem e Controle de Doa√ß√µes.</p>
        </section>

        <section class="form-container">
            <form id="mainForm" autocomplete="off">
                
                <input type="hidden" id="idCandidato">

                <h2 class="form-title"><i class="fa-solid fa-user-pen"></i> Dados do Respons√°vel</h2>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="responsavel">Nome Completo</label>
                        <input type="text" id="responsavel" required placeholder="Ex: Maria da Silva">
                    </div>
                    <div class="input-group">
                        <label for="cpf">CPF</label>
                        <input type="text" id="cpf" required placeholder="000.000.000-00" maxlength="14">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="telefone">Telefone / WhatsApp</label>
                        <input type="tel" id="telefone" required placeholder="(21) 90000-0000" maxlength="15">
                    </div>
                    <div class="input-group">
                        <label for="renda">Renda Familiar (R$)</label>
                        <input type="number" id="renda" min="0" step="0.01" placeholder="Ex: 1200.00">
                    </div>
                </div>

                <h2 class="form-title"><i class="fa-solid fa-map-location-dot"></i> Endere√ßo & Fam√≠lia</h2>

                <div class="input-row">
                    <div class="input-group" style="flex: 1;">
                        <label for="cep">CEP</label>
                        <input type="text" id="cep" placeholder="00000-000" maxlength="9">
                    </div>
                    <div class="input-group" style="flex: 3;">
                        <label for="endereco">Endere√ßo Completo</label>
                        <input type="text" id="endereco" required placeholder="Rua, n√∫mero, bairro...">
                    </div>
                </div>

                <div class="input-group">
                    <label for="referencia">Ponto de Refer√™ncia</label>
                    <input type="text" id="referencia" placeholder="Ex: Pr√≥ximo √† escola...">
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="membros">Total de Pessoas</label>
                        <input type="number" id="membros" min="1" required>
                    </div>
                    <div class="input-group">
                        <label for="criancas">N¬∫ de Crian√ßas</label>
                        <input type="number" id="criancas" min="0">
                    </div>
                </div>

                <h2 class="form-title"><i class="fa-solid fa-heart-pulse"></i> Necessidades</h2>

                <div class="input-group">
                    <label for="necessidades">Prioridades da fam√≠lia</label>
                    <textarea id="necessidades" rows="2" placeholder="Ex: Cesta b√°sica, rem√©dios..."></textarea>
                </div>

                <div class="input-group">
                    <label for="observacoes">Observa√ß√µes</label>
                    <textarea id="observacoes" rows="2"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" id="btnSalvar" class="btn-submit">
                        <i class="fa-solid fa-plus"></i> Cadastrar Fam√≠lia
                    </button>
                    <button type="button" id="btnCancelar" class="btn-outline btn-danger" style="display: none;" onclick="cancelarEdicao()">
                        Cancelar Edi√ß√£o
                    </button>
                </div>
            </form>
        </section>

        <section class="list-container">
            <h2><i class="fa-solid fa-list-check"></i> Fam√≠lias Cadastradas</h2>
            <div class="table-responsive">
                <table class="dream-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Contato</th>
                            <th>Endere√ßo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCorpo">
                        </tbody>
                </table>
                <p id="msgVazio" class="empty-msg">Nenhuma fam√≠lia cadastrada ainda.</p>
            </div>
        </section>

    </main>

    <footer>
        <p>&copy; 2025 Iniciativa Dream Tech. Todos os direitos reservados.</p>
    </footer>

    <script src="JS/index.js"></script>

    <script>
    (function () {
      const KEY_DB = 'dreamtech_db_familias_final'; // Nome do banco no navegador
      
      // Elementos
      const form = document.getElementById('mainForm');
      const tabelaCorpo = document.getElementById('tabelaCorpo');
      const msgVazio = document.getElementById('msgVazio');
      const btnSalvar = document.getElementById('btnSalvar');
      const btnCancelar = document.getElementById('btnCancelar');

      // --- 1. FUN√á√ïES DE M√ÅSCARA (Digita√ß√£o) ---
      
      const mascaraCPF = (valor) => {
          return valor
              .replace(/\D/g, '')
              .replace(/(\d{3})(\d)/, '$1.$2')
              .replace(/(\d{3})(\d)/, '$1.$2')
              .replace(/(\d{3})(\d{1,2})/, '$1-$2')
              .replace(/(-\d{2})\d+?$/, '$1');
      }

      const mascaraTel = (valor) => {
          return valor
              .replace(/\D/g, '')
              .replace(/(\d{2})(\d)/, '($1) $2')
              .replace(/(\d{5})(\d)/, '$1-$2')
              .replace(/(-\d{4})\d+?$/, '$1');
      }

      const mascaraCEP = (valor) => {
          return valor
              .replace(/\D/g, '')
              .replace(/^(\d{5})(\d)/, '$1-$2')
              .replace(/(-\d{3})\d+?$/, '$1');
      }

      // --- 2. BUSCA AUTOM√ÅTICA DE CEP ---
      function buscarEndereco(cep) {
          const campoEndereco = document.getElementById('endereco');
          const cepLimpo = cep.replace(/\D/g, ''); // Tira o tra√ßo

          if (cepLimpo.length === 8) {
              campoEndereco.value = "Buscando...";
              campoEndereco.disabled = true;

              fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (!data.erro) {
                        // Preenche: Rua, Bairro - Cidade/UF
                        campoEndereco.value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
                    } else {
                        alert("CEP n√£o encontrado!");
                        campoEndereco.value = "";
                    }
                })
                .catch(() => campoEndereco.value = "")
                .finally(() => campoEndereco.disabled = false);
          }
      }


      // --- 3. ATIVAR EVENTOS NOS INPUTS ---
      
      // Evento CPF
      document.getElementById('cpf').addEventListener('input', function(e) {
          e.target.value = mascaraCPF(e.target.value);
      });

      // Evento Telefone
      document.getElementById('telefone').addEventListener('input', function(e) {
          e.target.value = mascaraTel(e.target.value);
      });

      // Evento CEP
      document.getElementById('cep').addEventListener('input', function(e) {
          let valor = e.target.value;
          e.target.value = mascaraCEP(valor);
          
          // Se completou 9 d√≠gitos (12345-678), busca o endere√ßo
          if (valor.length === 9) {
              buscarEndereco(valor);
          }
      });


      // --- 4. FUN√á√ïES DO BANCO DE DADOS (CRUD) ---

      const lerBD = () => JSON.parse(localStorage.getItem(KEY_DB)) ?? [];
      const setBD = (db) => localStorage.setItem(KEY_DB, JSON.stringify(db));

      const salvarFamilia = (e) => {
          e.preventDefault();
          
          // Pega dados
          const familia = {
              id: document.getElementById('idCandidato').value || new Date().getTime().toString(),
              responsavel: document.getElementById('responsavel').value,
              cpf: document.getElementById('cpf').value,
              telefone: document.getElementById('telefone').value,
              renda: document.getElementById('renda').value,
              cep: document.getElementById('cep').value,
              endereco: document.getElementById('endereco').value,
              referencia: document.getElementById('referencia').value,
              membros: document.getElementById('membros').value,
              criancas: document.getElementById('criancas').value,
              necessidades: document.getElementById('necessidades').value,
              observacoes: document.getElementById('observacoes').value
          };

          const db = lerBD();
          const index = db.findIndex(f => f.id == familia.id);

          if (index == -1) {
              db.push(familia); // Novo
              alert("Fam√≠lia cadastrada com sucesso! ‚úÖ");
          } else {
              db[index] = familia; // Edi√ß√£o
              alert("Cadastro atualizado! üîÑ");
          }

          setBD(db);
          limparCampos();
          atualizarTabela();
      };

      const atualizarTabela = () => {
          const db = lerBD();
          limparTabela();

          if (db.length === 0) {
              msgVazio.style.display = 'block';
          } else {
              msgVazio.style.display = 'none';
              db.forEach(criarLinha);
          }
      }

      const criarLinha = (cliente) => {
          const novaLinha = document.createElement('tr');
          novaLinha.innerHTML = `
              <td><strong>${cliente.responsavel}</strong></td>
              <td>${cliente.cpf}</td>
              <td>${cliente.telefone}</td>
              <td>${cliente.endereco.split('-')[1] || cliente.endereco}</td>
              <td>
                  <button type="button" class="btn-action btn-edit" onclick="editarFamilia('${cliente.id}')">
                      <i class="fa-solid fa-pen"></i>
                  </button>
                  <button type="button" class="btn-action btn-delete" onclick="excluirFamilia('${cliente.id}')">
                      <i class="fa-solid fa-trash"></i>
                  </button>
              </td>
          `;
          tabelaCorpo.appendChild(novaLinha);
      }

      const limparTabela = () => {
          while (tabelaCorpo.firstChild) {
              tabelaCorpo.removeChild(tabelaCorpo.lastChild);
          }
      }

      const limparCampos = () => {
          form.reset();
          document.getElementById('idCandidato').value = '';
          btnSalvar.innerHTML = '<i class="fa-solid fa-plus"></i> Cadastrar Fam√≠lia';
          btnSalvar.classList.remove('btn-warning');
          btnCancelar.style.display = 'none';
      }

      // Fun√ß√µes Globais (para funcionar no onclick do HTML)
      window.excluirFamilia = (id) => {
          if (confirm("Deseja realmente excluir este cadastro?")) {
              const db = lerBD();
              const novoDb = db.filter(item => item.id != id);
              setBD(novoDb);
              atualizarTabela();
          }
      }

      window.editarFamilia = (id) => {
          const db = lerBD();
          const familia = db.find(item => item.id == id);
          if (familia) {
              document.getElementById('idCandidato').value = familia.id;
              document.getElementById('responsavel').value = familia.responsavel;
              document.getElementById('cpf').value = familia.cpf;
              document.getElementById('telefone').value = familia.telefone;
              document.getElementById('renda').value = familia.renda;
              document.getElementById('cep').value = familia.cep;
              document.getElementById('endereco').value = familia.endereco;
              document.getElementById('referencia').value = familia.referencia;
              document.getElementById('membros').value = familia.membros;
              document.getElementById('criancas').value = familia.criancas;
              document.getElementById('necessidades').value = familia.necessidades;
              document.getElementById('observacoes').value = familia.observacoes;

              btnSalvar.innerHTML = '<i class="fa-solid fa-rotate"></i> Atualizar Dados';
              btnSalvar.classList.add('btn-warning');
              btnCancelar.style.display = 'inline-block';
              
              document.querySelector('.form-header').scrollIntoView({ behavior: 'smooth' });
          }
      }

      window.cancelarEdicao = () => limparCampos();

      // Inicializa√ß√£o
      form.addEventListener('submit', salvarFamilia);
      atualizarTabela();

    })();
    </script>
</body>
</html>
